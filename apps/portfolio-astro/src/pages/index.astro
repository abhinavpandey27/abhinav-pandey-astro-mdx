---
import '../styles/global.css';
import NavHeader from '../components/NavHeader.astro';
import HeroSection from '../components/HeroSection.astro';
import ProjectStory from '../components/ProjectStory.astro';
import AboutSection from '../components/AboutSection.astro';
import ContactStrip from '../components/ContactStrip.astro';
import type { HeroCarouselItem } from '../components/HeroSection.astro';
import type { CollectionEntry } from 'astro:content';
import { getCollection, getEntry } from 'astro:content';
const FALLBACK_MEDIA = '/media/placeholder.webp';

const fallbackSite = {
  title: 'Abhinav Pandey — Portfolio',
  heroTagline: 'Motion-rich stories for teams shipping immersive products.',
  location: 'Mumbai, India',
  intro:
    'I craft end-to-end product experiences for teams who want motion to feel intentional, thoughtful, and accessible.',
  bioSnippet: 'Previously at Orbit Labs and Flux Studio.',
  email: 'hello@abhinavpandey.design',
  navLinks: [
    { label: 'Work', href: '#work' },
    { label: 'About', href: '#about' },
    { label: 'Contact', href: '#contact' }
  ],
  socialLinks: [
    {
      label: 'linkedin' as const,
      url: 'https://www.linkedin.com/in/abhinavpandey',
      ariaLabel: 'View Abhinav on LinkedIn'
    },
    {
      label: 'dribbble' as const,
      url: 'https://dribbble.com/abhinavpandey',
      ariaLabel: 'View Abhinav on Dribbble'
    }
  ],
  heroCarousel: [
    {
      asset: FALLBACK_MEDIA,
      alt: 'Placeholder hero artwork',
      caption: 'Add hero carousel items from Tina.',
      emphasis: 'primary' as const,
      width: undefined,
      height: undefined
    }
  ],
  motion: {
    prefersReducedMotionCopy: 'Animations respect your motion preferences — opt-out anytime.'
  },
  featuredProject: { collection: 'projects', slug: 'project-atlas' }
};

const [siteEntry] = await getCollection('site');
const siteEntryActual = (siteEntry ?? ({
  id: 'fallback-site',
  slug: 'fallback-site',
  body: '',
  data: fallbackSite,
  collection: 'site'
} as unknown as CollectionEntry<'site'>));
const site = siteEntryActual.data ?? fallbackSite;

const socialLabelMap: Record<string, string> = {
  twitter: 'Twitter',
  linkedin: 'LinkedIn',
  email: 'Email',
  behance: 'Behance',
  dribbble: 'Dribbble',
  github: 'GitHub'
};

const navLinks = site.navLinks?.length ? site.navLinks : fallbackSite.navLinks;
const socialLinksSource = site.socialLinks?.length ? site.socialLinks : fallbackSite.socialLinks;
const socialLinks = socialLinksSource.map((link) => ({
  label: socialLabelMap[link.label] ?? link.label,
  url: link.url,
  ariaLabel: link.ariaLabel
}));

const title = site.title ?? fallbackSite.title;
const ownerName = title.split('—')[0]?.trim() ?? title;
const location = site.location ?? fallbackSite.location;
const heroTagline = site.heroTagline ?? fallbackSite.heroTagline;
const introCopy = site.intro ?? fallbackSite.intro;
const bioSnippet = site.bioSnippet ?? fallbackSite.bioSnippet;
const prefersReducedMotionCopy =
  site.motion?.prefersReducedMotionCopy ?? fallbackSite.motion.prefersReducedMotionCopy;

const primaryEmail = site.email ?? fallbackSite.email;

const heroCarousel: HeroCarouselItem[] = (site.heroCarousel?.length ? site.heroCarousel : fallbackSite.heroCarousel).map(
  (item) => ({
    src: item.asset,
    alt: item.alt,
    caption: item.caption,
    emphasis: item.emphasis,
    width: 'width' in item ? item.width : undefined,
    height: 'height' in item ? item.height : undefined
  })
);

const projects = await getCollection('projects');
const [aboutEntry] = await getCollection('about');

// Theme registry: maps section IDs to theme tokens
type ThemeTokens = {
  bg?: string;
  text?: string;
  accent?: string;
  typography?: {
    fontFamily?: string;
    fontSize?: string;
    fontWeight?: string;
    lineHeight?: string;
    letterSpacing?: string;
  };
};

const normalizeTheme = (theme?: ThemeTokens): ThemeTokens => {
  if (!theme) {
    return {};
  }
  return {
    bg: theme.bg,
    text: theme.text,
    accent: theme.accent,
    typography: theme.typography
  };
};

const themeMap: Record<string, ThemeTokens> = {};

// Hero section theme (from site settings)
const heroTheme = normalizeTheme(site.theme);
if (Object.keys(heroTheme).length > 0) {
  themeMap['top'] = heroTheme;
} else {
  // Default hero theme
  themeMap['top'] = {
    bg: '#ffffff',
    text: '#0b0c11',
    accent: '#5763ff',
    typography: {
      fontFamily: 'Instrument Sans',
      fontSize: '16px',
      fontWeight: '500',
      lineHeight: '24px',
      letterSpacing: '-0.2px'
    }
  };
}

// Project themes
projects.forEach((project) => {
  const projectTheme = normalizeTheme(project.data.theme);
  if (Object.keys(projectTheme).length > 0) {
    themeMap[project.slug] = projectTheme;
  } else {
    // Default project theme based on sectionBackground
    const bgType = project.data.motion?.sectionBackground ?? 'dark';
    if (bgType === 'dark') {
      themeMap[project.slug] = {
        bg: '#090e03',
        text: '#ffffff',
        accent: '#5763ff'
      };
    } else if (bgType === 'light') {
      themeMap[project.slug] = {
        bg: '#f6f6fb',
        text: '#0b0c11',
        accent: '#5763ff'
      };
    } else {
      themeMap[project.slug] = {
        bg: '#1d2032',
        text: '#ffffff',
        accent: '#5763ff'
      };
    }
  }
});

// About section theme
if (aboutEntry) {
  const aboutTheme = normalizeTheme(aboutEntry.data.theme);
  if (Object.keys(aboutTheme).length > 0) {
    themeMap['about'] = aboutTheme;
  } else {
    const bgType = aboutEntry.data.motion?.sectionBackground ?? 'light';
    if (bgType === 'dark') {
      themeMap['about'] = {
        bg: '#0b0c11',
        text: '#ffffff',
        accent: '#5763ff'
      };
    } else if (bgType === 'light') {
      themeMap['about'] = {
        bg: '#f8f8fb',
        text: '#0b0c11',
        accent: '#5763ff'
      };
    } else {
      themeMap['about'] = {
        bg: '#24263e',
        text: '#ffffff',
        accent: '#5763ff'
      };
    }
  }
}

// Contact section default theme
themeMap['contact'] = {
  bg: '#0b0c11',
  text: '#ffffff',
  accent: '#5763ff'
};

const fallbackProject = {
  kicker: 'Featured project',
  title: 'Add a highlighted project in Tina',
  summary: 'Select a featured project inside the Site Settings collection to replace this placeholder.',
  metadata: [
    { label: 'Role', value: 'Design Lead' },
    { label: 'Timeline', value: 'Timeline TBD' }
  ],
  cta: {
    label: 'Contact',
    href: `mailto:${primaryEmail}`,
    isExternal: true
  }
};

let featuredProject = fallbackProject;

if (siteEntry && site.featuredProject) {
  const featuredProjectEntry = await getEntry(site.featuredProject);
  if (featuredProjectEntry && featuredProjectEntry.collection === 'projects') {
    const project = featuredProjectEntry.data;
    const projectTeam = project.team.length ? project.team.join(', ') : undefined;
    const projectCta =
      project.cta ??
      ({
        label: 'View project',
        href: `/projects/${featuredProjectEntry.slug}`,
        isExternal: false
      } as const);

    featuredProject = {
      kicker: project.hero?.kicker ?? fallbackProject.kicker,
      title: project.title,
      summary: project.summary,
      metadata: [
        { label: 'Role', value: project.role },
        { label: 'Timeline', value: project.timeline },
        ...(projectTeam ? [{ label: 'Team', value: projectTeam }] : [])
      ],
      cta: projectCta
    };
  }
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={introCopy} />
    <title>{title}</title>
  </head>

  <body>
    <a class="sr-only" href="#main">Skip to content</a>

    <main id="main">
      <div class="hero-wrapper" data-theme-section="top">
        <div class="hero-grid">
          <div class="hero-grid__nav">
            <NavHeader
              name={ownerName}
              location={location}
              navLinks={navLinks}
              socialLinks={socialLinks}
              menuLabel="Menu"
            />
          </div>
          <HeroSection
            id="top"
            heroTagline={heroTagline}
            intro={introCopy}
            bioSnippet={bioSnippet}
            prefersReducedMotionCopy={prefersReducedMotionCopy}
            featured={featuredProject}
            carousel={heroCarousel}
          />
        </div>
      </div>

      {projects.length > 0 && (
        <section id="work" class="work-section">
          {projects.map((project, index) => (
            <ProjectStory
              project={project}
              variant={project.data.storyLayout ?? (index % 2 === 0 ? 'case-study' : 'metrics')}
              data-theme-section={project.slug}
            />
          ))}
        </section>
      )}

      {aboutEntry && (
        <div data-theme-section="about">
          <AboutSection about={aboutEntry} />
        </div>
      )}

      <div data-theme-section="contact">
        <ContactStrip site={siteEntryActual} />
      </div>
    </main>

    <script define:vars={{ themeMap: JSON.stringify(themeMap) }}>
      (function initScrollTheming() {
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');
        const themeMapObj = JSON.parse(themeMap);
        const root = document.documentElement;
        let activeId: string | null = null;

        // Apply theme to root CSS variables
        const applyTheme = (sectionId: string) => {
          const theme = themeMapObj[sectionId];
          if (!theme) return;

          if (theme.bg) {
            root.style.setProperty('--theme-bg', theme.bg);
          }
          if (theme.text) {
            root.style.setProperty('--theme-text', theme.text);
          }
          if (theme.accent) {
            root.style.setProperty('--theme-accent', theme.accent);
          }
          if (theme.typography) {
            if (theme.typography.fontFamily) {
              root.style.setProperty('--theme-font-family', theme.typography.fontFamily);
            }
            if (theme.typography.fontSize) {
              root.style.setProperty('--theme-font-size', theme.typography.fontSize);
            }
            if (theme.typography.fontWeight) {
              root.style.setProperty('--theme-font-weight', theme.typography.fontWeight);
            }
            if (theme.typography.lineHeight) {
              root.style.setProperty('--theme-line-height', theme.typography.lineHeight);
            }
            if (theme.typography.letterSpacing) {
              root.style.setProperty('--theme-letter-spacing', theme.typography.letterSpacing);
            }
          }

          root.setAttribute('data-active-theme', sectionId);
        };

        // Initialize with first section
        const sections = Array.from(document.querySelectorAll('[data-theme-section]'));
        if (sections.length > 0) {
          const firstSection = sections[0] as HTMLElement;
          const firstId = firstSection.getAttribute('data-theme-section');
          if (firstId) {
            activeId = firstId;
            applyTheme(firstId);
          }
        }

        // Set up IntersectionObserver
        const isMobile = window.innerWidth < 768;
        const threshold = isMobile ? 0.3 : 0.5; // Lower threshold on mobile to prevent flicker

        const observer = new IntersectionObserver(
          (entries) => {
            // Find the entry with the highest intersection ratio
            let maxRatio = 0;
            let dominantEntry: IntersectionObserverEntry | null = null;

            entries.forEach((entry) => {
              if (entry.isIntersecting && entry.intersectionRatio > maxRatio) {
                maxRatio = entry.intersectionRatio;
                dominantEntry = entry;
              }
            });

            if (dominantEntry && dominantEntry.isIntersecting) {
              const target = dominantEntry.target as HTMLElement;
              const sectionId = target.getAttribute('data-theme-section');
              if (sectionId && sectionId !== activeId) {
                activeId = sectionId;
                applyTheme(sectionId);
              }
            }
          },
          {
            threshold: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0],
            rootMargin: isMobile ? '-20% 0px -20% 0px' : '-10% 0px -10% 0px'
          }
        );

        // Observe all theme sections
        sections.forEach((section) => {
          observer.observe(section);
        });

        // Handle resize to adjust thresholds
        let resizeTimeout: number;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = window.setTimeout(() => {
            // Re-check on resize
            sections.forEach((section) => {
              observer.unobserve(section);
              observer.observe(section);
            });
          }, 150);
        });
      })();
    </script>
  </body>
</html>

<style>
  .hero-wrapper {
    padding: var(--space-sm) 0;
    min-height: 100vh;
    background: var(--theme-bg, #ffffff);
    color: var(--theme-text, var(--color-label-primary));
    transition: background-color 0.6s ease, color 0.6s ease;
  }

  @media (prefers-reduced-motion: reduce) {
    .hero-wrapper {
      transition: background-color 0.15s ease, color 0.15s ease;
    }
  }

  .hero-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-template-rows: repeat(16, minmax(0, 1fr));
    gap: var(--grid-gap);
    min-height: 100vh;
    border: 1px solid var(--color-label-quaternary);
    border-top: none;
    border-bottom: none;
    padding: var(--grid-padding);
  }

  .hero-grid__nav {
    grid-column: 1 / span 12;
    grid-row: 1 / span 2;
    align-self: start;
  }

  .work-section {
    display: grid;
    gap: 0;
  }
</style>
