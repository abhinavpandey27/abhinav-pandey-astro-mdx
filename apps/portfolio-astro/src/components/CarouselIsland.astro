---
import type { HeroCarouselItem } from './HeroSection.astro';

interface Props {
  id?: string;
  items: HeroCarouselItem[];
  autoplayInterval?: number;
}

const {
  id = 'carousel',
  items = [],
  autoplayInterval = 5000
} = Astro.props as Props;

const carouselId = `${id}-${Math.random().toString(36).slice(2, 7)}`;
const hasMultipleSlides = items.length > 1;
---

<section
  class="carousel"
  aria-roledescription="carousel"
  aria-label="Featured project imagery"
  data-carousel
  data-interval={autoplayInterval}
  id={carouselId}
>
  <div class="carousel__viewport" data-carousel-track role="list">
    {items.map((item, index) => {
      const delay = typeof item.motionDelay === 'number' ? item.motionDelay : index * 0.12;
      return (
      <article
        class="carousel__slide"
        data-active={index === 0}
        role="listitem"
        tabindex="0"
        style={`--carousel-delay:${delay}s`}
        data-index={index}
      >
        <figure>
          <img src={item.src} alt={item.alt} loading="lazy" width={item.width} height={item.height} />
          {item.caption && <figcaption>{item.caption}</figcaption>}
        </figure>
      </article>
    );
    })}
  </div>

</section>

{hasMultipleSlides && (
  <script is:inline>
    (function() {
      const root = document.currentScript?.previousElementSibling;
      if (!root) {
        throw new Error('Carousel root not found');
      }

      root.tabIndex = 0;
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');
      const track = root.querySelector('[data-carousel-track]');
      if (!track) {
        return;
      }

      const slides = Array.from(track.children);
      const interval = Number(root.dataset.interval) || 5000;
      let index = 0;
      let timer;
      let isVisible = false;
      let isAutoplayEnabled = false;

      const activate = (nextIndex, focus = false) => {
        index = nextIndex;
        slides.forEach((slide, slideIndex) => {
          slide.dataset.active = String(slideIndex === index);
        });

        const target = slides[index];
        if (target && track) {
          // Scroll to show full slide
          const targetOffsetLeft = target.offsetLeft;
          track.scrollTo({ left: targetOffsetLeft, behavior: 'smooth' });
          
          if (focus) {
            target.focus({ preventScroll: true });
          }
        }
      };

      const start = () => {
        // Only start if conditions are met
        if (prefersReducedMotion.matches || slides.length < 2 || !isVisible || isAutoplayEnabled) {
          return;
        }
        stop();
        isAutoplayEnabled = true;
        timer = window.setInterval(() => {
          const next = (index + 1) % slides.length;
          activate(next);
        }, interval);
      };

      const stop = () => {
        if (timer) {
          window.clearInterval(timer);
          timer = undefined;
          isAutoplayEnabled = false;
        }
      };

      // IntersectionObserver to gate autoplay based on visibility (â‰¥60% threshold)
      const visibilityObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const wasVisible = isVisible;
            isVisible = entry.isIntersecting && entry.intersectionRatio >= 0.6;
            
            if (isVisible && !wasVisible) {
              // Carousel became visible, start autoplay if conditions allow
              if (!prefersReducedMotion.matches && slides.length >= 2) {
                start();
              }
            } else if (!isVisible && wasVisible) {
              // Carousel became hidden or below threshold, stop autoplay
              stop();
            }
          });
        },
        {
          threshold: [0, 0.6, 1.0],
          rootMargin: '0px'
        }
      );

      // Handle page visibility changes
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          stop();
        } else if (isVisible && !prefersReducedMotion.matches && slides.length >= 2) {
          start();
        }
      });

      // Pause on hover/focus
      root.addEventListener('mouseenter', stop);
      root.addEventListener('mouseleave', () => {
        if (isVisible && !prefersReducedMotion.matches && slides.length >= 2) {
          start();
        }
      });
      root.addEventListener('focusin', stop);
      root.addEventListener('focusout', (event) => {
        // Only restart if focus moved outside the carousel
        if (!root.contains(event.relatedTarget) && isVisible && !prefersReducedMotion.matches && slides.length >= 2) {
          start();
        }
      });

      // Restrict keyboard handling to only when carousel is focused
      root.addEventListener('keydown', (event) => {
        // Only handle if carousel or its children have focus
        const activeElement = document.activeElement;
        if (!root.contains(activeElement)) {
          return;
        }

        if (event.key === 'ArrowRight') {
          event.preventDefault();
          const next = (index + 1) % slides.length;
          activate(next, true);
        } else if (event.key === 'ArrowLeft') {
          event.preventDefault();
          const next = (index - 1 + slides.length) % slides.length;
          activate(next, true);
        }
      });


      // Handle prefers-reduced-motion changes
      prefersReducedMotion.addEventListener('change', (event) => {
        if (event.matches) {
          root.classList.add('is-reduced');
          stop();
        } else {
          root.classList.remove('is-reduced');
          if (isVisible && slides.length >= 2) {
            start();
          }
        }
      });

      // Initial setup
      if (prefersReducedMotion.matches) {
        root.classList.add('is-reduced');
      } else {
        root.classList.remove('is-reduced');
        // Start autoplay immediately if carousel is visible
        if (slides.length >= 2) {
          // Check if carousel is already visible
          const rect = root.getBoundingClientRect();
          const isInViewport = rect.top < window.innerHeight && rect.bottom > 0;
          if (isInViewport) {
            isVisible = true;
            // Start autoplay immediately
            start();
          } else {
            // If not visible, wait for intersection observer
            visibilityObserver.observe(root);
          }
        } else {
          // Always observe if we have slides
          visibilityObserver.observe(root);
        }
      }

      activate(0);
    })();
  </script>
)}

<style>
  .carousel {
    position: relative;
    border-radius: 0;
    overflow: hidden;
    max-height: 500px;
    height: 500px;
    width: 100%;
  }

  .carousel__viewport {
    display: flex;
    gap: 0;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    overscroll-behavior-x: contain;
    max-height: 500px;
    height: 500px;
    width: 100%;
  }

  .carousel__viewport::-webkit-scrollbar {
    display: none;
  }

  .carousel__slide {
    flex: 0 0 100%;
    scroll-snap-align: start;
    position: relative;
    border-radius: 0;
    overflow: hidden;
    transition: transform 0.4s ease;
    max-height: 500px;
    height: 500px;
    width: 100%;
  }

  .carousel__slide figure {
    margin: 0;
    display: block;
    height: 100%;
    max-height: 500px;
  }

  .carousel__slide img {
    width: 100%;
    height: 100%;
    max-height: 500px;
    object-fit: cover;
    display: block;
  }

  .carousel__slide figcaption {
    padding: var(--space-sm);
    font-size: 13px;
    color: var(--color-label-secondary);
  }


  .carousel.is-reduced {
    padding: 0;
    border: none;
    background: transparent;
  }

  .carousel.is-reduced .carousel__viewport {
    display: grid;
    gap: var(--space-md);
    overflow: visible;
    scroll-snap-type: none;
  }

  .carousel.is-reduced .carousel__slide {
    transform: none;
    box-shadow: none;
    flex: 1 1 auto;
    opacity: 1;
    animation: none;
  }


  @media (max-width: 720px) {
    .carousel {
      padding: var(--space-sm);
      max-height: 400px;
    }

    .carousel__viewport {
      max-height: 400px;
    }

    .carousel__slide {
      max-height: 400px;
    }

    .carousel__slide figure {
      max-height: 400px;
    }

    .carousel__slide img {
      height: auto;
      max-height: 400px;
    }
  }

  @keyframes carouselEnter {
    from {
      opacity: 0;
      transform: translateY(18px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .carousel__slide {
      animation: none;
      opacity: 1;
      transform: none;
    }
  }
</style>
