---
export type CaseStudyItem = {
  videoUrl?: string;
  posterImage?: { asset: string; alt: string };
  title: string;
  calloutSubtitle?: string;
  description: string;
  externalLink?: string;
  slug: string;
};

interface Props {
  caseStudies: CaseStudyItem[];
  id?: string;
}

const { caseStudies = [], id = "case-study-stack" } = Astro.props as Props;

const placeholder = {
  title: "Case Study",
  calloutSubtitle: "Featured Work",
  description: "Add a highlighted case study to replace this placeholder.",
  posterImage: {
    asset: "/media/placeholder.webp",
    alt: "Placeholder case study",
  },
  slug: "#",
};

const primaryStudy = caseStudies[0] ?? placeholder;
const hasStack = caseStudies.length > 1;
---

<section class="case-study-stack" id={id} aria-label="Featured case studies">
  <button
    class="case-study-stack__trigger"
    type="button"
    aria-label="View all case studies"
    data-case-study-trigger
    data-case-studies={JSON.stringify(caseStudies)}
    data-cursor="VIEW CASE STUDY"
  >
    <div
      class={`case-study-card ${hasStack ? "case-study-card--stacked" : ""}`}
    >
      <div class="case-study-card__media-wrapper">
        {
          primaryStudy.posterImage && (
            <img
              src={primaryStudy.posterImage.asset}
              alt={primaryStudy.posterImage.alt}
              class="case-study-card__image"
              loading="lazy"
              width="600"
              height="450"
            />
          )
        }
      </div>

      <div class="case-study-card__content">
        <div class="case-study-card__header">
          <span class="case-study-card__label">Featured Case Study</span>
          {
            hasStack && (
              <span class="case-study-card__badge">
                +{caseStudies.length - 1} more
              </span>
            )
          }
        </div>

        <h3 class="case-study-card__title">
          {primaryStudy.calloutSubtitle ?? primaryStudy.title}
        </h3>
        <p class="case-study-card__description">{primaryStudy.description}</p>
      </div>
    </div>

    {hasStack && <div class="case-study-stack-effect" aria-hidden="true" />}
  </button>
</section>

<script>
  // Click handler to open overlay
  (function () {
    const stack = document.currentScript?.previousElementSibling;
    if (!stack) return;

    const trigger = stack.querySelector(
      "[data-case-study-trigger]",
    ) as HTMLButtonElement;

    if (trigger) {
      trigger.addEventListener("click", () => {
        const caseStudiesData = trigger.getAttribute("data-case-studies");
        if (caseStudiesData) {
          const event = new CustomEvent("openCaseStudyOverlay", {
            detail: JSON.parse(caseStudiesData),
            bubbles: true,
          });
          document.dispatchEvent(event);
        }
      });
    }
  })();
</script>

<style>
  .case-study-stack {
    display: block;
    width: 100%;
    position: relative;
  }

  .case-study-stack__trigger {
    position: relative;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    width: 100%;
    text-align: left;
    transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .case-study-stack__trigger:hover {
    transform: translateY(-2px); /* Reduced hover movement */
  }

  .case-study-card {
    position: relative;
    background: var(--surface-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    padding: var(--space-sm); /* Reduced padding from md */
    overflow: hidden;
    z-index: 2;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm); /* Kept as sm, but padding is reduced */
    box-shadow: var(--shadow-soft);
  }

  .case-study-card__media-wrapper {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: var(--surface-sidebar);
    border: 1px solid rgba(0, 0, 0, 0.04);
  }

  .case-study-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .case-study-stack__trigger:hover .case-study-card__image {
    transform: scale(1.03);
  }

  .case-study-card__content {
    display: flex;
    flex-direction: column;
    gap: 4px; /* Reduced gap */
  }

  .case-study-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0; /* Removed margin */
  }

  .case-study-card__label {
    font-family: var(--font-sans);
    font-size: var(--text-label-size);
    line-height: var(--text-label-height);
    letter-spacing: var(--text-label-spacing);
    font-weight: 400; /* Regular weight */
    text-transform: var(--text-label-case);
    color: var(--color-label-secondary);
  }

  .case-study-card__badge {
    font-family: var(--font-sans);
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 99px;
    background: var(--surface-sidebar);
    color: var(--color-label-primary);
    border: 1px solid var(--border-subtle);
    font-weight: 400; /* Regular weight */
  }

  .case-study-card__title {
    margin: 0;
    font-family: var(--font-sans);
    font-size: var(--text-body-size); /* Reduced size */
    line-height: var(--text-body-height);
    letter-spacing: var(--text-title-spacing);
    font-weight: 400; /* Regular weight */
    color: var(--color-label-primary);
  }

  .case-study-card__description {
    margin: 0;
    font-family: var(--font-sans);
    font-size: var(--text-caption-size); /* Reduced size */
    line-height: var(--text-caption-height);
    letter-spacing: var(--text-secondary-spacing);
    font-weight: 400; /* Regular weight */
    color: var(--color-label-secondary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Stack Effect */
  .case-study-stack-effect {
    position: absolute;
    top: 4px; /* Reduced offset */
    left: 4px;
    right: 4px;
    bottom: -4px;
    background: var(--surface-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    z-index: 1;
    box-shadow: var(--shadow-soft);
    opacity: 0.5;
    transition:
      transform 0.3s ease,
      opacity 0.3s ease;
  }

  .case-study-stack__trigger:hover .case-study-stack-effect {
    transform: translateY(2px) scale(0.99); /* Adjusted hover effect */
    opacity: 0.6;
  }
</style>
