---
import type { CaseStudyItem } from './CaseStudyStack.astro';

interface Props {
  caseStudies: CaseStudyItem[];
}

const { caseStudies = [] } = Astro.props as Props;
---

<div id="case-study-overlay" class="case-study-overlay" role="dialog" aria-modal="true" aria-labelledby="overlay-title" hidden>
  <div class="case-study-overlay__backdrop"></div>
  <div class="case-study-overlay__content">
    <button class="case-study-overlay__close" type="button" aria-label="Close overlay">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    
    <div class="case-study-overlay__header">
      <h2 id="overlay-title" class="case-study-overlay__title">Case Studies</h2>
    </div>

    <div class="case-study-overlay__scroll">
      <div class="case-study-overlay__list">
        {caseStudies.map((study, index) => (
          <article class="case-study-overlay__item" data-index={index}>
            <div class="case-study-overlay__media">
              {study.videoUrl && study.videoUrl.trim() !== '' ? (
                <video
                  class="case-study-overlay__video"
                  poster={study.posterImage?.asset}
                  muted
                  loop
                  playsinline
                  controls
                >
                  <source src={study.videoUrl} type="video/mp4" />
                </video>
              ) : study.posterImage ? (
                <img
                  src={study.posterImage.asset}
                  alt={study.posterImage.alt}
                  class="case-study-overlay__image"
                />
              ) : null}
              {study.calloutSubtitle && (
                <div class="case-study-overlay__callout">
                  {study.calloutSubtitle}
                </div>
              )}
            </div>
            <div class="case-study-overlay__details">
              <span class="case-study-overlay__label">CASE STUDY</span>
              <h3 class="case-study-overlay__item-title">{study.title}</h3>
              <p class="case-study-overlay__item-description">{study.description}</p>
              <div class="case-study-overlay__actions">
                {study.slug && (
                  <a href={`#${study.slug}`} class="case-study-overlay__cta case-study-overlay__cta--primary">
                    View Project
                  </a>
                )}
                {study.externalLink && (
                  <a href={study.externalLink} target="_blank" rel="noopener noreferrer" class="case-study-overlay__cta case-study-overlay__cta--secondary">
                    External Link
                    <span aria-hidden="true">↗</span>
                  </a>
                )}
              </div>
            </div>
          </article>
        ))}
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const overlay = document.getElementById('case-study-overlay');
    const closeButton = overlay?.querySelector('.case-study-overlay__close') as HTMLButtonElement;
    const backdrop = overlay?.querySelector('.case-study-overlay__backdrop') as HTMLElement;
    const listContainer = overlay?.querySelector('.case-study-overlay__list') as HTMLElement;

    if (!overlay) return;

    function openOverlay(caseStudies?: any[]) {
      if (overlay) {
        // If case studies are provided, update the list
        if (caseStudies && caseStudies.length > 0 && listContainer) {
          listContainer.innerHTML = caseStudies.map((study, index) => `
            <article class="case-study-overlay__item" data-index="${index}">
              <div class="case-study-overlay__media">
                ${study.videoUrl && study.videoUrl.trim() !== '' ? `
                  <video
                    class="case-study-overlay__video"
                    poster="${study.posterImage?.asset || ''}"
                    muted
                    loop
                    playsinline
                    controls
                  >
                    <source src="${study.videoUrl}" type="video/mp4" />
                  </video>
                ` : study.posterImage ? `
                  <img
                    src="${study.posterImage.asset}"
                    alt="${study.posterImage.alt}"
                    class="case-study-overlay__image"
                  />
                ` : ''}
                ${study.calloutSubtitle ? `
                  <div class="case-study-overlay__callout">
                    ${study.calloutSubtitle}
                  </div>
                ` : ''}
              </div>
              <div class="case-study-overlay__details">
                <span class="case-study-overlay__label">CASE STUDY</span>
                <h3 class="case-study-overlay__item-title">${study.title}</h3>
                <p class="case-study-overlay__item-description">${study.description}</p>
                <div class="case-study-overlay__actions">
                  ${study.slug ? `
                    <a href="#${study.slug}" class="case-study-overlay__cta case-study-overlay__cta--primary">
                      View Project
                    </a>
                  ` : ''}
                  ${study.externalLink ? `
                    <a href="${study.externalLink}" target="_blank" rel="noopener noreferrer" class="case-study-overlay__cta case-study-overlay__cta--secondary">
                      External Link
                      <span aria-hidden="true">↗</span>
                    </a>
                  ` : ''}
                </div>
              </div>
            </article>
          `).join('');
        }

        overlay.hidden = false;
        document.body.style.overflow = 'hidden';
        // Focus trap
        closeButton?.focus();
      }
    }

    function closeOverlay() {
      if (overlay) {
        overlay.hidden = true;
        document.body.style.overflow = '';
      }
    }

    // Listen for custom event from CaseStudyStack
    document.addEventListener('openCaseStudyOverlay', ((e: CustomEvent) => {
      openOverlay(e.detail);
    }) as EventListener);

    // Close handlers
    closeButton?.addEventListener('click', closeOverlay);
    backdrop?.addEventListener('click', closeOverlay);

    // ESC key handler
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && overlay && !overlay.hidden) {
        closeOverlay();
      }
    });

    // Focus trap
    overlay.addEventListener('keydown', (e) => {
      if (e.key !== 'Tab') return;

      const focusableElements = overlay.querySelectorAll(
        'a[href], button:not([disabled]), textarea, input, select'
      );
      const firstFocusable = focusableElements[0] as HTMLElement;
      const lastFocusable = focusableElements[focusableElements.length - 1] as HTMLElement;

      if (e.shiftKey) {
        if (document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable?.focus();
        }
      } else {
        if (document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable?.focus();
        }
      }
    });
  })();
</script>

<style>
  .case-study-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .case-study-overlay[hidden] {
    display: none;
  }

  .case-study-overlay__backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
  }

  .case-study-overlay__content {
    position: relative;
    width: 100%;
    max-width: 1200px;
    max-height: 90vh;
    background: var(--color-surface-black);
    color: var(--color-label-primary-dark);
    border-radius: var(--radius-lg);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    margin: var(--space-xl);
    z-index: 1001;
  }

  .case-study-overlay__close {
    position: absolute;
    top: var(--space-md);
    right: var(--space-md);
    z-index: 1002;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-sm);
    color: var(--color-label-primary-dark);
    cursor: pointer;
    transition: background 0.2s ease, border-color 0.2s ease;
  }

  .case-study-overlay__close:hover,
  .case-study-overlay__close:focus-visible {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .case-study-overlay__header {
    padding: var(--space-xl);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-material-thin);
  }

  .case-study-overlay__title {
    margin: 0;
    font-family: var(--font-family-heading);
    font-size: var(--font-size-h4);
    line-height: var(--line-height-h4);
    letter-spacing: var(--letter-spacing-h4);
    font-weight: var(--font-weight-h4);
    color: var(--color-label-primary-dark);
  }

  .case-study-overlay__scroll {
    overflow-y: auto;
    flex: 1;
    padding: var(--space-xl);
  }

  .case-study-overlay__list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xl);
  }

  .case-study-overlay__item {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-xl);
    padding-bottom: var(--space-2xl);
    border-bottom: 1px solid var(--color-material-thin);
  }

  .case-study-overlay__item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .case-study-overlay__media {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--color-label-quaternary-dark);
  }

  .case-study-overlay__video,
  .case-study-overlay__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .case-study-overlay__callout {
    position: absolute;
    left: var(--space-md);
    top: var(--space-md);
    padding: 4px var(--space-sm);
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(20px);
    border-radius: 99px;
    font-family: var(--font-family-ui);
    font-size: 10px;
    line-height: 14px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--color-surface-white);
    font-weight: 500;
  }

  .case-study-overlay__details {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .case-study-overlay__label {
    font-family: var(--font-family-ui);
    font-size: 11px;
    line-height: 14px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--color-label-secondary-dark);
    font-weight: 400;
  }

  .case-study-overlay__item-title {
    margin: 0;
    font-family: var(--font-family-heading);
    font-size: 32px;
    line-height: 36px;
    letter-spacing: -0.8px;
    font-weight: 600;
    color: var(--color-label-primary-dark);
  }

  .case-study-overlay__item-description {
    margin: 0;
    font-family: var(--font-family-body);
    font-size: var(--font-size-body-md);
    line-height: var(--line-height-body-md);
    letter-spacing: var(--letter-spacing-body-md);
    color: var(--color-label-secondary-dark);
  }

  .case-study-overlay__actions {
    display: flex;
    gap: var(--space-md);
    margin-top: var(--space-sm);
  }

  .case-study-overlay__cta {
    padding: var(--space-sm) var(--space-lg);
    border-radius: var(--radius-sm);
    font-family: var(--font-family-body);
    font-size: var(--font-size-body-md);
    line-height: var(--line-height-body-md);
    letter-spacing: var(--letter-spacing-body-md);
    text-decoration: none;
    transition: opacity 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .case-study-overlay__cta--primary {
    background: var(--color-label-primary-dark);
    color: var(--color-surface-black);
  }

  .case-study-overlay__cta--secondary {
    background: transparent;
    color: var(--color-label-primary-dark);
    border: 1px solid var(--color-material-thin);
  }

  .case-study-overlay__cta:hover,
  .case-study-overlay__cta:focus-visible {
    opacity: 0.8;
  }

  @media (max-width: 960px) {
    .case-study-overlay__content {
      margin: var(--space-md);
      max-height: 95vh;
    }

    .case-study-overlay__item {
      grid-template-columns: 1fr;
      gap: var(--space-lg);
    }

    .case-study-overlay__item-title {
      font-size: 24px;
      line-height: 28px;
    }

    .case-study-overlay__actions {
      flex-direction: column;
    }

    .case-study-overlay__cta {
      width: 100%;
      justify-content: center;
    }
  }
</style>

