---
import type { CollectionEntry } from 'astro:content';
import CarouselIsland from './CarouselIsland.astro';
import type { HeroCarouselItem } from './HeroSection.astro';
import { Callout, OutcomeMetric } from './mdx';
import { getCollection } from 'astro:content';

interface Props {
  about: CollectionEntry<'about'>;
  id?: string;
}

const { about, id } = Astro.props as Props;
const data = about.data;
const { Content } = await about.render();

const gallery: HeroCarouselItem[] = data.gallery.map((item) => ({
  src: item.asset,
  alt: item.alt,
  caption: item.caption,
  emphasis: item.emphasis ?? 'primary',
  motionDelay: data.motion?.galleryStagger,
  width: 'width' in item ? item.width : undefined,
  height: 'height' in item ? item.height : undefined
}));

const sectionBackground = data.motion?.sectionBackground ?? 'light';
const sectionClass = ['about-section', `about-section--${sectionBackground}`].join(' ');
const mdxComponents = { Callout, OutcomeMetric };

// Get social links from site settings
const [siteEntry] = await getCollection('site');
const socialLinks = siteEntry?.data?.socialLinks ?? [];
const resume = siteEntry?.data?.resume;

const socialLabelMap: Record<string, string> = {
  twitter: 'Twitter',
  linkedin: 'LinkedIn',
  email: 'E-Mail',
  behance: 'Behance',
  dribbble: 'Dribbble',
  github: 'GitHub'
};

// Ensure we have Twitter, Email, LinkedIn, and Resume in the correct order
const orderedSocialLinks = [];
const twitterLink = socialLinks.find(link => link.label.toLowerCase() === 'twitter');
const emailLink = socialLinks.find(link => link.label.toLowerCase() === 'email');
const linkedinLink = socialLinks.find(link => link.label.toLowerCase() === 'linkedin');
const resumeLink = resume ? {
  label: 'resume',
  url: resume.file,
  ariaLabel: resume.label || 'Download resume'
} : null;

// Add in order: Twitter, Email, LinkedIn, Resume
if (twitterLink) orderedSocialLinks.push(twitterLink);
if (emailLink) orderedSocialLinks.push(emailLink);
if (linkedinLink) orderedSocialLinks.push(linkedinLink);
if (resumeLink) orderedSocialLinks.push(resumeLink);

const formattedSocialLinks = orderedSocialLinks.map((link) => ({
  label: socialLabelMap[link.label] ?? (link.label.toLowerCase() === 'resume' ? 'Resume' : link.label),
  url: link.url,
  ariaLabel: link.ariaLabel,
  isResume: link.label.toLowerCase() === 'resume' || link.url?.endsWith('.pdf')
}));
---

<section class={sectionClass} id={id ?? 'about'}>
  <div class="about-section__grid">
    <div class="about-section__top">
      <div class="about-section__intro">
        <p class="about-section__intro-text">7+ years of experience in product and service design. I worked in both big corporations and small startups, always striving to turn complex things into intuitive and thoughtful ones.</p>
        <p class="about-section__intro-secondary">
          Did 0→1 for a new player-card-based fantasy system. Designed, tested, and shipped core UX and final UI under high ambiguity with rapid iteration. Balanced gamification, education, and monetization through a clean, mobile-first design approach that scaled across drops, fantasy, and crafting flows.
        </p>
      </div>
      <div class="about-section__top-right">
        <button type="button" class="about-section__menu-button" aria-label="Menu">
          <span>menu</span>
          <span class="about-section__menu-icon" aria-hidden="true"></span>
        </button>
      </div>
    </div>

    {gallery.length > 0 && (
      <div class="about-section__gallery">
        <CarouselIsland id="about-gallery" items={gallery} autoplayInterval={7000} />
      </div>
    )}

    <div class="about-section__bottom">
      <div class="about-section__bottom-left">
        <div class="about-section__info-section">
          <p class="about-section__info-label">Colophon</p>
          <p class="about-section__info-text">
            The font used on this site is our custom creation, DBCo. Metaphor. Our frontend code is{' '}
            <a href="https://github.com/design-business-company/dbco-frontend" target="_blank" rel="noopener noreferrer">open-sourced</a>
            {' '}and can be found here. We utilize Nuxt/Vue 3 and Sanity to bring this site to life.
          </p>
        </div>
        <div class="about-section__info-section">
          <p class="about-section__info-label">Thank You</p>
          <p class="about-section__info-text">
            The font used on this site is our custom creation, DBCo. Metaphor. Our frontend code is{' '}
            <a href="https://github.com/design-business-company/dbco-frontend" target="_blank" rel="noopener noreferrer">open-sourced</a>
            {' '}and can be found here. We utilize Nuxt/Vue 3 and Sanity to bring this site to life.
          </p>
        </div>
      </div>
      <div class="about-section__bottom-right">
        <nav aria-label="Social links" class="about-section__social">
          {formattedSocialLinks.slice(0, 2).length > 0 && (
            <ul class="about-section__social-links">
              {formattedSocialLinks.slice(0, 2).map((link) => (
                <li>
                  <a
                    class="about-section__social-link"
                    href={link.url}
                    target={link.isResume ? undefined : '_blank'}
                    rel={link.isResume ? undefined : 'noopener noreferrer'}
                    aria-label={link.ariaLabel ?? link.label}
                    download={link.isResume ? true : undefined}
                  >
                    {link.label} {link.isResume ? '↓' : '↗'}
                  </a>
                </li>
              ))}
            </ul>
          )}
          {formattedSocialLinks.slice(2, 4).length > 0 && (
            <ul class="about-section__social-links">
              {formattedSocialLinks.slice(2, 4).map((link) => (
                <li>
                  <a
                    class="about-section__social-link"
                    href={link.url}
                    target={link.isResume ? undefined : '_blank'}
                    rel={link.isResume ? undefined : 'noopener noreferrer'}
                    aria-label={link.ariaLabel ?? link.label}
                    download={link.isResume ? true : undefined}
                  >
                    {link.label} {link.isResume ? '↓' : '↗'}
                  </a>
                </li>
              ))}
            </ul>
          )}
        </nav>
      </div>
    </div>
  </div>
</section>

<style>
  .about-section {
    padding: var(--space-sm) var(--grid-padding);
    min-height: 100vh;
    background: var(--theme-bg, var(--color-surface-white));
    color: var(--theme-text, var(--color-label-primary));
    transition: background-color var(--theme-transition-duration, 0.6s) var(--theme-transition-easing, cubic-bezier(0.4, 0, 0.2, 1)), 
      color var(--theme-transition-duration, 0.6s) var(--theme-transition-easing, cubic-bezier(0.4, 0, 0.2, 1));
  }

  .about-section--light {
    background: var(--color-surface-white);
    color: var(--color-label-primary);
  }

  .about-section--dark {
    background: var(--color-surface-black);
    color: var(--color-label-primary-dark);
  }

  @media (prefers-reduced-motion: reduce) {
    .about-section {
      transition: background-color 0.15s ease, color 0.15s ease;
    }
  }

  .about-section__grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-template-rows: repeat(16, minmax(0, 1fr));
    gap: var(--grid-gap);
    min-height: 100vh;
    border: 1px solid var(--color-label-quaternary);
    border-top: none;
    border-bottom: none;
    padding: var(--grid-padding) 0;
  }

  .about-section__top {
    grid-column: 1 / span 12;
    grid-row: 1 / span 3;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-2xl);
    padding: var(--space-sm) var(--grid-padding);
  }

  .about-section__intro {
    display: flex;
    flex: 1 0 0;
    gap: var(--space-2xl);
    align-items: flex-start;
  }

  .about-section__intro-text {
    margin: 0;
    font-family: var(--font-sans);
    font-size: var(--text-display-size);
    line-height: var(--text-display-height);
    letter-spacing: var(--text-display-spacing);
    font-weight: var(--text-display-weight);
    color: var(--color-label-primary);
    width: 595px;
  }

  .about-section--dark .about-section__intro-text {
    color: var(--color-label-primary-dark);
  }

  .about-section__intro-secondary {
    margin: 0;
    font-family: var(--font-sans);
    font-size: var(--text-heading-size); /* Used Heading size (20px) for emphasis */
    line-height: var(--text-title-height);
    letter-spacing: var(--text-title-spacing);
    font-weight: 400;
    color: var(--color-label-secondary);
    width: 583px;
  }

  .about-section--dark .about-section__intro-secondary {
    color: var(--color-label-secondary-dark);
  }

  .about-section__top-right {
    display: flex;
    align-items: center;
    gap: 40px;
  }

  .about-section__menu-button {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    border: none;
    border-radius: var(--radius-lg);
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-label-primary);
    font-family: var(--font-sans);
    font-size: var(--text-label-size);
    line-height: var(--text-label-height);
    letter-spacing: var(--text-label-spacing);
    font-weight: var(--text-label-weight);
    text-transform: var(--text-label-case);
    color: var(--color-surface-white);
    cursor: pointer;
    transition: opacity 0.2s ease;
    white-space: nowrap;
  }

  .about-section__menu-button:hover,
  .about-section__menu-button:focus-visible {
    opacity: 0.9;
  }

  .about-section__menu-icon {
    position: relative;
    width: 16px;
    height: 16px;
  }

  .about-section__menu-icon::before,
  .about-section__menu-icon::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    height: 1px;
    background: currentColor;
  }

  .about-section__menu-icon::before {
    top: 25%;
  }

  .about-section__menu-icon::after {
    bottom: 25%;
  }

  .about-section__gallery {
    grid-column: 1 / span 12;
    grid-row: 4 / span 10;
  }

  .about-section__bottom {
    grid-column: 1 / span 12;
    grid-row: 14 / span 2;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-2xl);
    padding: var(--space-sm) var(--grid-padding);
  }

  .about-section__bottom-left {
    display: flex;
    align-items: center;
    gap: 89px;
  }

  .about-section__info-section {
    display: flex;
    flex-direction: column;
    gap: 0;
    width: 477px;
  }

  .about-section__info-label {
    margin: 0;
    font-family: var(--font-sans);
    font-size: var(--text-body-size);
    line-height: var(--text-body-height);
    letter-spacing: var(--text-body-spacing);
    font-weight: var(--text-body-weight);
    color: var(--color-label-secondary);
  }

  .about-section--dark .about-section__info-label {
    color: var(--color-label-secondary-dark);
  }

  .about-section__info-text {
    margin: 0;
    font-family: var(--font-sans);
    font-size: var(--text-body-size);
    line-height: var(--text-body-height);
    letter-spacing: var(--text-body-spacing);
    font-weight: var(--text-body-weight);
    color: var(--color-label-primary);
  }

  .about-section--dark .about-section__info-text {
    color: var(--color-label-primary-dark);
  }

  .about-section__info-text a {
    text-decoration: underline;
    color: inherit;
  }

  .about-section__bottom-right {
    display: flex;
    align-items: center;
    gap: 30px;
  }

  .about-section__social {
    display: flex;
    gap: 30px;
  }

  .about-section__social-links {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0;
    margin: 0;
    padding: 0;
    list-style: none;
    width: 117px;
  }

  .about-section__social-link {
    font-family: var(--font-sans);
    font-size: var(--text-body-size);
    line-height: var(--text-body-height);
    letter-spacing: var(--text-body-spacing);
    font-weight: var(--text-body-weight);
    color: var(--color-label-secondary);
    text-align: right;
    transition: color 0.2s ease;
  }

  .about-section--dark .about-section__social-link {
    color: var(--color-label-secondary-dark);
  }

  .about-section__social-link:hover,
  .about-section__social-link:focus-visible {
    color: var(--color-label-primary);
  }

  .about-section--dark .about-section__social-link:hover,
  .about-section--dark .about-section__social-link:focus-visible {
    color: var(--color-label-primary-dark);
  }
</style>
