---
import { type CollectionEntry } from 'astro:content';
import CarouselIsland from './CarouselIsland.astro';
import type { HeroCarouselItem } from './HeroSection.astro';
import { Callout, OutcomeMetric } from './mdx';

type ProjectEntry = CollectionEntry<'projects'>;
type Variant = 'case-study' | 'metrics';

interface Props {
  project: ProjectEntry;
  variant?: Variant;
  id?: string;
  'data-theme-section'?: string;
}

const { project, variant = 'case-study', id, 'data-theme-section': themeSection } = Astro.props as Props;
const data = project.data;
const layoutVariant = data.storyLayout ?? variant;
const { Content } = await project.render();
const mdxComponents = { Callout, OutcomeMetric };

const outcomes = data.outcomes ?? [];
const deliverables = data.deliverables ?? [];
const ctas = data.ctas ?? [];
const legacyCta = data.cta;

const gallery: HeroCarouselItem[] = data.gallery.map((item) => ({
  src: item.asset,
  alt: item.alt,
  caption: item.caption,
  emphasis: item.emphasis ?? 'primary',
  motionDelay: item.motionDelay,
  width: 'width' in item ? item.width : undefined,
  height: 'height' in item ? item.height : undefined
}));

const background = data.motion?.sectionBackground ?? 'dark';

const sectionClasses = [
  'project-story',
  `project-story--${background}`,
  `project-story--${layoutVariant}`
].join(' ');
---

<section
  class={sectionClasses}
  id={id ?? project.slug}
  data-variant={layoutVariant}
  data-theme-section={themeSection ?? project.slug}
>
  <div class="project-story__wrapper">
    <div class="project-story__header">
      <div class="project-story__main-info">
        <div class="project-story__title-row">
          {data.hero?.media && (
            <img 
              src={data.hero.media.asset} 
              alt={data.hero.media.alt} 
              class="project-story__icon"
              width="48"
              height="48"
            />
          )}
          <div class="project-story__titles">
            <h2 class="project-story__title">{data.title}</h2>
            {data.hero?.kicker && (
              <p class="project-story__subtitle">{data.hero.kicker}</p>
            )}
          </div>
        </div>

        <div class="project-story__body">
          <p class="project-story__summary">{data.summary}</p>
          
          <div class="project-story__tags">
            {deliverables.length > 0 && deliverables.map((d) => (
              <span class="project-story__tag">{d}</span>
            ))}
            
            {(ctas.length > 0 || legacyCta) && (
              <div class="project-story__actions">
                {ctas.map((cta) => (
                  <a
                    class="project-story__tag project-story__tag--action"
                    href={cta.href}
                    target={cta.isExternal ? '_blank' : undefined}
                    rel={cta.isExternal ? 'noopener noreferrer' : undefined}
                  >
                    {cta.label}
                  </a>
                ))}
                {legacyCta && ctas.length === 0 && (
                  <a
                    class="project-story__tag project-story__tag--action"
                    href={legacyCta.href}
                    target={legacyCta.isExternal ? '_blank' : undefined}
                    rel={legacyCta.isExternal ? 'noopener noreferrer' : undefined}
                  >
                    {legacyCta.label}
                  </a>
                )}
              </div>
            )}
          </div>
        </div>
      </div>

      {outcomes.length > 0 && (
        <div class="project-story__metrics">
          <ul class="project-story__metrics-list">
            {outcomes.map((outcome) => (
              <li class="project-story__metric-item">
                <span class="project-story__metric-value">{outcome.value}</span>
                <span class="project-story__metric-label">{outcome.label}</span>
              </li>
            ))}
          </ul>
          
          <div class="project-story__meta">
            <span class="project-story__meta-item">{data.role}</span>
            <span class="project-story__meta-item">{data.timeline}</span>
          </div>
        </div>
      )}
    </div>

    {gallery.length > 0 && (
      <div class="project-story__gallery">
        <CarouselIsland id={`${project.slug}-gallery`} items={gallery} autoplayInterval={6000} />
      </div>
    )}
  </div>
</section>

<style>
  .project-story {
    padding: var(--space-2xl) 0;
    min-height: auto;
    background: transparent;
    color: var(--color-label-primary);
  }

  .project-story__wrapper {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  .project-story__header {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: var(--space-2xl);
    align-items: start;
    border-bottom: 1px solid var(--color-label-quaternary);
    padding-bottom: var(--space-xl);
  }

  .project-story__main-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .project-story__title-row {
    display: flex;
    align-items: flex-start; /* Changed from center to start for better alignment with multi-line titles */
    gap: var(--space-md);
  }

  .project-story__icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-sm);
    object-fit: cover;
    flex-shrink: 0;
    background: var(--surface-sidebar);
  }

  .project-story__titles {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding-top: 2px; /* Optical alignment with icon */
  }

  .project-story__title {
    margin: 0;
    font-family: var(--font-sans);
    font-size: var(--text-title-size);
    line-height: var(--text-title-height);
    font-weight: 600;
    color: var(--color-label-primary);
  }

  .project-story__subtitle {
    margin: 0;
    font-family: var(--font-sans);
    font-size: var(--text-body-size);
    line-height: var(--text-body-height);
    color: var(--color-label-secondary);
  }

  .project-story__body {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .project-story__summary {
    margin: 0;
    font-family: var(--font-sans);
    font-size: var(--text-body-size);
    line-height: var(--text-body-height);
    color: var(--color-label-primary);
    max-width: 60ch;
  }

  .project-story__tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .project-story__tag {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    background: var(--color-label-quaternary);
    border-radius: 99px;
    font-family: var(--font-sans);
    font-size: var(--text-label-size);
    line-height: var(--text-label-height);
    letter-spacing: var(--text-label-spacing);
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-label-primary);
    text-decoration: none;
  }

  .project-story__tag--action {
    background: var(--color-label-primary);
    color: var(--color-surface-white);
    transition: opacity 0.2s ease;
  }
  
  .project-story__tag--action:hover {
    opacity: 0.9;
  }
  
  .project-story__actions {
    display: contents;
  }

  .project-story__metrics {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    padding-left: var(--space-xl);
    border-left: 1px solid var(--color-label-quaternary);
  }

  .project-story__metrics-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .project-story__metric-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  .project-story__metric-item::before {
    content: "â€¢";
    color: var(--color-label-primary);
    position: absolute;
    margin-left: -16px;
    font-weight: bold;
  }
  
  .project-story__metric-item {
    position: relative;
    margin-left: 16px;
  }

  .project-story__metric-value {
    font-family: var(--font-sans);
    font-size: var(--text-title-size);
    line-height: var(--text-title-height);
    font-weight: 600;
    color: var(--color-label-primary);
  }

  .project-story__metric-label {
    font-family: var(--font-sans);
    font-size: var(--text-secondary-size);
    line-height: var(--text-secondary-height);
    color: var(--color-label-secondary);
  }

  .project-story__meta {
    display: flex;
    gap: var(--space-lg);
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-label-quaternary);
  }

  .project-story__meta-item {
    font-family: var(--font-sans);
    font-size: var(--text-label-size);
    line-height: var(--text-label-height);
    letter-spacing: var(--text-label-spacing);
    text-transform: uppercase;
    color: var(--color-label-tertiary);
    font-weight: 600;
  }

  .project-story__gallery {
    width: 100%;
    /* Aspect ratio or fixed height? Reference shows full width bleed or contained */
    height: auto;
  }
  
  .project-story__gallery :global(.carousel) {
    aspect-ratio: 16/9;
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  @media (max-width: 960px) {
    .project-story__header {
      grid-template-columns: 1fr;
      gap: var(--space-xl);
    }

    .project-story__metrics {
      padding-left: 0;
      border-left: none;
      border-top: 1px solid var(--color-label-quaternary);
      padding-top: var(--space-lg);
    }
    
    .project-story__meta {
      flex-wrap: wrap;
      gap: var(--space-md);
    }
  }
</style>
