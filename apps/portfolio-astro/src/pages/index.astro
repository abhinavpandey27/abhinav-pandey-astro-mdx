---
import '../styles/global.css';
import NavHeader from '../components/NavHeader.astro';
import HeroSection from '../components/HeroSection.astro';
import ProjectStory from '../components/ProjectStory.astro';
import AboutSection from '../components/AboutSection.astro';
import ContactStrip from '../components/ContactStrip.astro';
import type { HeroCarouselItem } from '../components/HeroSection.astro';
import type { CollectionEntry } from 'astro:content';
import { getCollection, getEntry } from 'astro:content';
const FALLBACK_MEDIA = '/media/placeholder.webp';

const fallbackSite = {
  title: 'Abhinav Pandey — Portfolio',
  heroTagline: 'Motion-rich stories for teams shipping immersive products.',
  location: 'Mumbai, India',
  intro:
    'I craft end-to-end product experiences for teams who want motion to feel intentional, thoughtful, and accessible.',
  bioSnippet: 'Previously at Orbit Labs and Flux Studio.',
  email: 'hello@abhinavpandey.design',
  navLinks: [
    { label: 'Work', href: '#work' },
    { label: 'About', href: '#about' },
    { label: 'Contact', href: '#contact' }
  ],
  socialLinks: [
    {
      label: 'linkedin' as const,
      url: 'https://www.linkedin.com/in/abhinavpandey',
      ariaLabel: 'View Abhinav on LinkedIn'
    },
    {
      label: 'dribbble' as const,
      url: 'https://dribbble.com/abhinavpandey',
      ariaLabel: 'View Abhinav on Dribbble'
    }
  ],
  heroCarousel: [
    {
      asset: FALLBACK_MEDIA,
      alt: 'Placeholder hero artwork',
      caption: 'Add hero carousel items from Tina.',
      emphasis: 'primary' as const,
      width: undefined,
      height: undefined
    }
  ],
  motion: {
    prefersReducedMotionCopy: 'Animations respect your motion preferences — opt-out anytime.'
  },
  featuredProject: { collection: 'projects', slug: 'project-atlas' }
};

const [siteEntry] = await getCollection('site');
const siteEntryActual = (siteEntry ?? ({
  id: 'fallback-site',
  slug: 'fallback-site',
  body: '',
  data: fallbackSite,
  collection: 'site'
} as unknown as CollectionEntry<'site'>));
const site = siteEntryActual.data ?? fallbackSite;

const socialLabelMap: Record<string, string> = {
  twitter: 'Twitter',
  linkedin: 'LinkedIn',
  email: 'Email',
  behance: 'Behance',
  dribbble: 'Dribbble',
  github: 'GitHub'
};

const navLinks = site.navLinks?.length ? site.navLinks : fallbackSite.navLinks;
const socialLinksSource = site.socialLinks?.length ? site.socialLinks : fallbackSite.socialLinks;
const socialLinks = socialLinksSource.map((link) => ({
  label: socialLabelMap[link.label] ?? link.label,
  url: link.url,
  ariaLabel: link.ariaLabel
}));

const title = site.title ?? fallbackSite.title;
const ownerName = title.split('—')[0]?.trim() ?? title;
const location = site.location ?? fallbackSite.location;
const heroTagline = site.heroTagline ?? fallbackSite.heroTagline;
const introCopy = site.intro ?? fallbackSite.intro;
const bioSnippet = site.bioSnippet ?? fallbackSite.bioSnippet;
const prefersReducedMotionCopy =
  site.motion?.prefersReducedMotionCopy ?? fallbackSite.motion.prefersReducedMotionCopy;

const primaryEmail = site.email ?? fallbackSite.email;

const heroCarousel: HeroCarouselItem[] = (site.heroCarousel?.length ? site.heroCarousel : fallbackSite.heroCarousel).map(
  (item) => ({
    src: item.asset,
    alt: item.alt,
    caption: item.caption,
    emphasis: item.emphasis,
    width: 'width' in item ? item.width : undefined,
    height: 'height' in item ? item.height : undefined
  })
);

const projects = await getCollection('projects');
const [aboutEntry] = await getCollection('about');

const fallbackProject = {
  kicker: 'Featured project',
  title: 'Add a highlighted project in Tina',
  summary: 'Select a featured project inside the Site Settings collection to replace this placeholder.',
  metadata: [
    { label: 'Role', value: 'Design Lead' },
    { label: 'Timeline', value: 'Timeline TBD' }
  ],
  cta: {
    label: 'Contact',
    href: `mailto:${primaryEmail}`,
    isExternal: true
  }
};

let featuredProject = fallbackProject;

if (siteEntry && site.featuredProject) {
  const featuredProjectEntry = await getEntry(site.featuredProject);
  if (featuredProjectEntry && featuredProjectEntry.collection === 'projects') {
    const project = featuredProjectEntry.data;
    const projectTeam = project.team.length ? project.team.join(', ') : undefined;
    const projectCta =
      project.cta ??
      ({
        label: 'View project',
        href: `/projects/${featuredProjectEntry.slug}`,
        isExternal: false
      } as const);

    featuredProject = {
      kicker: project.hero?.kicker ?? fallbackProject.kicker,
      title: project.title,
      summary: project.summary,
      metadata: [
        { label: 'Role', value: project.role },
        { label: 'Timeline', value: project.timeline },
        ...(projectTeam ? [{ label: 'Team', value: projectTeam }] : [])
      ],
      cta: projectCta
    };
  }
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={introCopy} />
    <title>{title}</title>
  </head>

  <body>
    <a class="sr-only" href="#main">Skip to content</a>

    <main id="main">
      <div class="hero-wrapper">
        <div class="hero-grid">
          <div class="hero-grid__nav">
            <NavHeader
              name={ownerName}
              location={location}
              navLinks={navLinks}
              socialLinks={socialLinks}
              menuLabel="Menu"
            />
          </div>
          <HeroSection
            id="top"
            heroTagline={heroTagline}
            intro={introCopy}
            bioSnippet={bioSnippet}
            prefersReducedMotionCopy={prefersReducedMotionCopy}
            featured={featuredProject}
            carousel={heroCarousel}
          />
        </div>
      </div>

      {projects.length > 0 && (
        <section id="work" class="work-section">
          {projects.map((project, index) => (
            <ProjectStory
              project={project}
              variant={project.data.storyLayout ?? (index % 2 === 0 ? 'case-study' : 'metrics')}
            />
          ))}
        </section>
      )}

      {aboutEntry && (
        <AboutSection about={aboutEntry} />
      )}

      <ContactStrip site={siteEntryActual} />
    </main>
  </body>
</html>

<style>
  .hero-wrapper {
    padding: var(--space-sm) 0;
  }

  .hero-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-template-rows: repeat(16, minmax(0, 1fr));
    gap: var(--grid-gap);
    height: 1097px;
    border: 1px solid var(--color-label-quaternary);
    border-top: none;
    border-bottom: none;
    padding: var(--grid-padding);
  }

  .hero-grid__nav {
    grid-column: 1 / span 12;
    grid-row: 1 / span 2;
    align-self: start;
  }

  .work-section {
    display: grid;
    gap: 0;
  }
</style>
