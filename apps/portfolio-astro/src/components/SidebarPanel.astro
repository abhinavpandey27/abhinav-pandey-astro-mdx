---
import CaseStudyStack from './CaseStudyStack.astro';
import type { CaseStudyItem } from './CaseStudyStack.astro';
import { getCollection } from 'astro:content';

export type NavLink = {
  label: string;
  href: string;
};

export type SocialLink = {
  label: string;
  url: string;
  ariaLabel?: string;
  isResume?: boolean;
  isIcon?: boolean;
};

interface Props {
  name: string;
  location: string;
  intro: string;
  navLinks: NavLink[];
  socialLinks: SocialLink[];
  email?: string;
  caseStudies?: CaseStudyItem[];
}

const {
  name,
  location,
  intro,
  navLinks = [],
  socialLinks = [],
  email,
  caseStudies = []
} = Astro.props as Props;

const [siteEntry] = await getCollection('site');

// Normalize all links into a single list for the sidebar
const allLinks = [
  ...navLinks.map(link => ({ ...link, type: 'nav', isExternal: false, isResume: false })),
  ...(siteEntry?.data?.resume ? [{ 
    label: 'resume', 
    href: siteEntry.data.resume.file, 
    type: 'social', 
    isResume: true,
    isExternal: false
  }] : []),
  ...socialLinks.map(link => ({ 
    label: link.label, 
    href: link.url, 
    type: 'social', 
    isIcon: link.label.toLowerCase() === 'twitter' || link.label.toLowerCase() === 'linkedin',
    isExternal: true,
    isResume: false
  }))
];

// Helper to get icon paths
const getIconPath = (label: string) => {
  const l = label.toLowerCase();
  if (l === 'work') return 'M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5Z M6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5V19.5'; // Book
  if (l === 'about') return 'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z'; // User
  if (l === 'resume') return 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6'; // File
  if (l === 'linkedin') return 'M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z M2 9h4v12H2z M4 2a2 2 0 1 1-2 2 2 2 0 0 1 2-2z'; // LinkedIn
  if (l === 'email') return 'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z M22 6l-10 7L2 6'; // Mail
  if (l === 'twitter') return 'M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z'; // Twitter
  if (l === 'whatsapp') return 'M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z'; // Whatsapp
  return 'M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z'; // Circle fallback
};
---

<aside class="sidebar-panel" aria-label="Navigation and profile">
  <div class="sidebar-panel__inner">
    <div class="sidebar-panel__greeting">
      <p class="sidebar-panel__hello">hello there! I'm {name.split(' ')[0].toLowerCase()}.</p>
      <p class="sidebar-panel__intro">{intro}</p>
    </div>

    <nav class="sidebar-panel__menu" aria-label="Main menu">
      <ul class="sidebar-panel__list" role="list">
        {allLinks.map((link) => (
          <li>
            <a 
              href={link.href} 
              class="sidebar-link"
              target={link.isExternal || link.isResume ? '_blank' : undefined}
              rel={link.isExternal ? 'noopener noreferrer' : undefined}
              download={link.isResume ? true : undefined}
            >
              <span class="sidebar-link__icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d={getIconPath(link.label)} />
                </svg>
              </span>
              <span class="sidebar-link__label">{link.label.toLowerCase()}</span>
            </a>
          </li>
        ))}
      </ul>
    </nav>

    {caseStudies.length > 0 && (
      <div class="sidebar-panel__case-study">
        <CaseStudyStack caseStudies={caseStudies} id="sidebar-case-studies" />
      </div>
    )}
  </div>
</aside>

<style>
  .sidebar-panel {
    height: 100vh;
    overflow: hidden;
    background: transparent !important;
    color: var(--color-label-primary);
    padding: var(--space-xl) var(--space-md);
    border-right: none;
    width: 100%;
    display: flex;
    flex-direction: column;
  }

  .sidebar-panel__inner {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xl);
    height: 100%;
    overflow: hidden;
    /* Align items to start */
  }

  .sidebar-panel__greeting {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    flex-shrink: 0;
  }

  .sidebar-panel__hello {
    margin: 0;
    font-family: var(--font-sans);
    font-size: var(--text-title-size);
    line-height: var(--text-title-height);
    font-weight: var(--text-title-weight);
    color: var(--color-label-primary);
  }

  .sidebar-panel__intro {
    margin: 0;
    font-family: var(--font-sans);
    font-size: var(--text-secondary-size);
    line-height: var(--text-secondary-height);
    color: var(--color-label-secondary);
  }

  .sidebar-panel__menu {
    display: flex;
    flex-direction: column;
  }

  .sidebar-panel__list {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .sidebar-link {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: 6px 12px;
    margin-left: -12px; /* Negative margin to align text visually while keeping hover box nice */
    text-decoration: none;
    color: var(--color-label-secondary);
    border-radius: var(--radius-sm); /* Round hover state */
    transition: background-color 0.2s ease, color 0.2s ease;
    width: 100%;
  }

  .sidebar-link:hover,
  .sidebar-link:focus-visible {
    background-color: var(--surface-sidebar); /* Consistent width background */
    color: var(--color-label-primary);
  }

  .sidebar-link__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    color: inherit;
    opacity: 0.8;
  }

  .sidebar-link:hover .sidebar-link__icon {
    opacity: 1;
  }

  .sidebar-link__label {
    font-family: var(--font-sans);
    font-size: var(--text-body-size);
    line-height: var(--text-body-height);
    font-weight: 500; /* Medium weight for links */
  }

  .sidebar-panel__case-study {
    margin-top: auto;
    flex-shrink: 0;
  }

  @media (max-width: 1024px) {
    .sidebar-panel {
      position: relative;
      height: auto;
      padding: var(--space-lg) var(--grid-padding);
      border-bottom: 1px solid var(--border-subtle);
    }

    .sidebar-panel__inner {
      gap: var(--space-xl);
    }
    
    .sidebar-link {
      margin-left: 0;
    }
  }
</style>
